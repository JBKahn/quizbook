{% extends "base.html" %}

{% block morehead%}
<link rel="stylesheet" href="{{ STATIC_PREFIX }}/static/quiz/css/quiz_template.css" type="text/css" />
<script src="http://variancecharts.com/cdn/variance-noncommercial-standalone-02c9f8b.min.js"
			charset="UTF-8"></script>
<style media="screen" type="text/css">
#graph {
  width: 400px;
  padding: 60px 80px 80px 41px;
  color: #001729;
  margin: -30px 0 -70px 0;
}
#graph h3 {
  text-align: center;
  margin: 0 0 28px 0;
}
#graph chart {
  width: 400px;
  height: 200px;
}
#graph bar {
  margin: 0 8px;
  border: none;
  background-color: #001729;
}
#graph annotation {
  text-transform: capitalize;
  font-size: 12px;
}

.grade_button:hover {
	color: black;
	cursor: hand;
}

#answer {
	border:2px solid;
	border-radius:10px;
	width: 80%;
    margin: 0 auto;
    padding: 10px;
}

#next {
    width: 25px;   
    left:0px;
    height:25px;
    position:absolute;
    display: block;
    background: url("http://i43.tinypic.com/25alqv7.png") 0px 0px ;
   
}

#prev {
    width: 25px;
    height: 25px;
	left:25px;
    position:absolute;
    display: block;
    background: url("http://i43.tinypic.com/25alqv7.png") 25px 0px ;
   
    z-index: 10;
    cursor: pointer;
   
    opacity: 0.8;
}

</style>
{% endblock %}

{% block title %}Course: {{ parent_course.name }}{% endblock %}

{% block header%}
Course: {{ parent_course.name }} <br>
Creator: {{ quiz.creator }} <br>
<!-- Date Created: {{ quiz.pub_date }} <br>
Last Modified: {{ quiz.modified_date }} <br> -->
{% if user_enrolled %}
Last recorded grade: {{ last_grade.grade }}

<div id="show_grade" class="white-link"><a href="">Show grade history</a></div>
<div id="hide_grade"><a href="">Hide grade history</a></div>

<div id="grade_history">
	<csv id="traffic">
		date,username,grade
		{% for grade in grade_list %}
		"{{  grade.created_at }}", {{  user.username }}, {{ grade.grade }},
		{% endfor %}
	</csv>
	<div id="graph">

	  <chart data="#traffic"
			 map-length="grade"
			 scale-y-linear="0 5">
		<guide-y></guide-y>
		<repeat>
		  <bar></bar>
		  <annotation class="bottom">
	<!--       	{% verbatim %}
				{{date}}
			{% endverbatim %} -->
		  </annotation>
		</repeat>
	  </chart>

	</div>
</div>
{% endif %}
{% endblock %}

{% block menu %}

{% if user_is_creator %}
<li><a href="{% url 'courses:edit_quiz' parent_course.id quiz.id %}">Edit</a></li>
<li id="delete_button" id="delete_button" name="delete_button"><a href="#">Delete</a></li>
<li id="really_delete_button" name="really_delete_button"><a href="{% url 'courses:delete_quiz' parent_course.id quiz.id %}">Confirm</a></li>
{% endif %}

<li class="back"><a href="{% url 'courses:detail' quiz.course.id %}">Back to {{ quiz.course.name }}</a></li>
{% endblock %}

{% block body %}

	{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
	<div id="random_quizes" style="display: none;">
		<div id="quiz" style="">
			<ul>
				<li>{{ quiz.question }}</li>
				<div id="reveal">
					<li>
						<a href="#">Reveal answer</a>
						
					</li>
				</div>
				<div id="answer" style="display: none">
					{{ quiz.answer }}

				</div>
				
				<button id="prev" type="button" style="display: none;"></button>
				<button id="next" data_index="1" data_max="{{ max }}" data_quiz_id="{{ quiz.id }}"  type="button" style="display: none;"></button>
				
				<li><a href="">Add an answer</a></li>
			</ul>
		</div>
	</div>

	<script>

		function get_next() {
			Dajaxice.quizbook_app.hello_ajax(Dajax.process,{'a':{{ quiz.id }},'index':0})
			// Dajaxice.quizbook_app.get_solution(Dajax.process,{'a':{{ quiz.id }},'index':0})
		};

		$('#next').click(function(){
			var quiz_id;
			var index;
			var max;
			quiz_id = $(this).attr("data_quiz_id");
			index = parseInt($(this).attr("data_index"), 10);
			max = parseInt($(this).attr("data_max"), 10);
			$.ajax({
			    type: "GET",
			    url:"/get_solution/",
			    data: {
			    'quiz_id': quiz_id,
			    'index': index,
			    },
			    success: function(data) {
			    	if ((index + 2) > max) {
			    		$('#next').hide();
			    	}
			    	$('#next').attr("data_index", index + 1);
			    	$('#prev').show()
			    	show_answer(data);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		});

		$('#prev').click(function() {
			var quiz_id;
			var index;
			var max;

			// Fetch data from #next button
			quiz_id = $('#next').attr("data_quiz_id");
			index = parseInt($('#next').attr("data_index"), 10);
			max = parseInt($(this).attr("data_max"), 10);
			$.ajax({
			    type: "GET",
			    url:"/get_solution/",
			    data: {
			    'quiz_id': quiz_id,
			    'index': (index - 2),
			    },
			    success: function(data) {
			    	if ((index - 3) < 0) {
			    		$('#prev').hide();
			    	}
			    	$('#next').attr("data_index", index - 1);
			    	$('#next').show()
			    	show_answer(data);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		});

		this.show_answer = function(answer) {
			$("#reveal").hide();
			$("#answer").hide();
			$('#answer').html(answer);
			MathJax.Hub.Queue(["Typeset",MathJax.Hub,"answer"], function() {
				$("#answer").fadeIn("slow");
			});
		};

		this.reveal_answer = function() {
			$("#reveal").hide();

			var quiz_id = $('#next').attr("data_quiz_id");
			var index = parseInt($('#next').attr("data_index"), 10);
			var max = parseInt($('#next').attr("data_max"), 10);

			$.ajax({
			    type: "GET",
			    url:"/get_solution/",
			    data: {
			    'quiz_id': quiz_id,
			    'index': 0,
			    },
			    success: function(data) {
			    	if (index < max) {
						$('#next').show();
					}
			    	show_answer(data);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		};

		$("#reveal").click(function(){
			reveal_answer();
		});

		// this.setup_solution_buttons = function() {
		// 	var quiz_id = $('#next').attr("data_quiz_id");
		// 	var index = parseInt($('#next').attr("data_index"), 10);
		// 	var max = parseInt($('#next').attr("data_max"), 10);
		// 	if (index < max) {
		// 		$('#next').show();
		// 	} else {
		// 		$('#next').hide();
		// 	}
		// 	$('#prev').hide();
		// }

		$( document ).ready(function() {
			setup_grade_history();
			{% if answer %}
			reveal_answer();
			{% endif %}
		});

		MathJax.Hub.Register.StartupHook("End Typeset", function (message) {
			$("#random_quizes").fadeIn("slow");
		})

		$("#delete_button").click(function(){
			$('#delete_button').hide();
			$('#really_delete_button').fadeIn();
			$('#really_delete_button').delay(3000).fadeOut(0, function() {
				$('#delete_button').show();
			});
			
		});

		this.setup_grade_history = function() {
			$( "#grade_history" ).hide();
			$( "#hide_grade" ).hide();
		}

		$( "#show_grade" ).click(function() {
			$( "#show_grade ").hide();
			$( "#hide_grade ").show();
			$( "#grade_history" ).show( "slow" );
		});

		$( "#hide_grade" ).click(function() {
			$( "#show_grade ").show();
			$( "#hide_grade ").hide();
			$( "#grade_history" ).hide( "slow" );
		});
	</script>

{% endblock %}