{% extends "base.html" %}

{% block morehead%}
<link rel="stylesheet" href="{{ STATIC_URL }}css/quiz_browse.css">
{% endblock %}

{% block title %}Course: {{ parent_course.name }}{% endblock %}

{% block header%}
	Course: {{ parent_course.name }} <br>
	Creator: {{ quiz.creator }} <br>
	{% if user_enrolled %}
		Last recorded grade: {{ last_grade.grade }}
		<div id="show_grade" class="white-link"><a href="">Show grade history</a></div>
		<div id="hide_grade"><a href="">Hide grade history</a></div>
		<div id="grade_history">
			<csv id="traffic">
				date,username,grade
				{% for grade in grade_list %}
				"{{  grade.created_at }}", {{  user.username }}, {{ grade.grade }},
				{% endfor %}
			</csv>
			<div id="graph">
			  <chart data="#traffic"
					 map-length="grade"
					 scale-y-linear="0 5">
				<guide-y></guide-y>
				<repeat>
				  <bar></bar>
				  <annotation class="bottom">
				  </annotation>
				</repeat>
			  </chart>
			</div>
		</div>
	{% endif %}
{% endblock %}

{% block second_header %}
	Creator: <span id='creator_span'></span> </br>
	Rank: <span id='rank_span'></span> </br>
	<div id='upvote_button' class='white-link' onclick='upvote();'>
		<a herf=''>Upvote</a>
	</div>
	<div id="delete_solution_button" class='white-link' onclick="delete_solution();"></div>
{% endblock %}

{% block menu %}

{% if user_is_creator %}
	<li><a href="{% url 'courses:edit_quiz' parent_course.id quiz.id %}">Edit</a></li>
	<li id="delete_button" id="delete_button" name="delete_button"><a href="#">Delete</a></li>
	<li id="really_delete_button" name="really_delete_button"><a href="{% url 'courses:delete_quiz' parent_course.id quiz.id %}">Confirm</a></li>
{% endif %}

<li class="back"><a href="{% url 'courses:detail' quiz.course.id %}">Back to {{ quiz.course.name }}</a></li>
{% endblock %}

{% block body %}

	{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
	<div id="random_quizes" style="display: none;">
		<div id="quiz" style="">
			<ul>
				<li>{{ quiz.question }}</li>
				<div id="reveal">
					<li>
						<a href="#">Reveal answer</a>
						
					</li>
				</div>
				<div id="answer" style="display: none">
					{{ quiz.answer }}
				</div>
				
				<li><a href="{% url 'courses:add_solution' quiz.course.id quiz.id %}">Add an answer</a></li>
			</ul>
		</div>
	</div>

		<nav>
			<span id="prev" class="cbp-fwprev">&lt;</span>
			<span id="next" data_index="1" data_max="{{ max }}" data_quiz_id="{{ quiz.id }}" class="cbp-fwnext">&gt;</span>
		</nav>

	<script>
		$('#next').click(function(){
			var quiz_id;
			var index;
			var max;
			quiz_id = $(this).attr("data_quiz_id");
			index = parseInt($(this).attr("data_index"), 10);
			max = parseInt($(this).attr("data_max"), 10);
			$.ajax({
			    type: "GET",
			    url:"/get_solution/",
			    data: {
			    'quiz_id': quiz_id,
			    'index': index,
			    },
			    success: function(data) {
			    	if ((index + 2) > max) {
			    		$('#next').hide();
			    	}
			    	$('#next').attr("data_index", index + 1);
			    	$('#prev').show()
			    	show_answer(data);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		});

		$('#prev').click(function() {
			var quiz_id;
			var index;
			var max;

			// Fetch data from #next button
			quiz_id = $('#next').attr("data_quiz_id");
			index = parseInt($('#next').attr("data_index"), 10);
			max = parseInt($(this).attr("data_max"), 10);
			$.ajax({
			    type: "GET",
			    url:"/get_solution/",
			    data: {
			    'quiz_id': quiz_id,
			    'index': (index - 2),
			    },
			    success: function(data) {
			    	if ((index - 3) < 0) {
			    		$('#prev').hide();
			    	}
			    	$('#next').attr("data_index", index - 1);
			    	$('#next').show()
			    	show_answer(data);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		});

		this.show_answer = function(data) {
			var answer = data.answer;
			var creator = data.creator;
			var rank = data.rank;

			$("#reveal").hide();
			$("#answer").hide();
			$('#answer').html(answer);
			$('.second_header').show();
			MathJax.Hub.Queue(["Typeset",MathJax.Hub,"answer"], function() {
				$('#creator_span').html(creator);
				$('#rank_span').html(rank);
				if (data.user_is_creator) {
					$('#delete_solution_button').html('<a href="#">Delete solution</a>');
				} else {
					$('#delete_solution_button').html('');
				}
				$("#answer").fadeIn("slow");
			});
		};

		this.reveal_answer = function() {
			$("#reveal").hide();

			var quiz_id = $('#next').attr("data_quiz_id");
			var index = parseInt($('#next').attr("data_index"), 10);
			var max = parseInt($('#next').attr("data_max"), 10);

			$.ajax({
			    type: "GET",
			    url:"/get_solution/",
			    data: {
			    'quiz_id': quiz_id,
			    'index': 0,
			    },
			    success: function(data) {
			    	if (index < max) {
						$('#next').show();
					}
			    	show_answer(data);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		};

		this.upvote = function() {
			var quiz_id = $('#next').attr("data_quiz_id");
			var index = parseInt($('#next').attr("data_index"), 10);
			var url_var = "{% url 'courses:upvote_solution' quiz.course.id quiz.id %}";
			$.ajax({
			    type: "get",
			    url: url_var,
			    data: {
			    	'quiz_id': quiz_id,
			    	'index': (index - 1)
			    },
			    success: function(data) {
					$('#rank_span').html(data.new_rank);
			    },
			    error: function() {
			        alert("Error");
			    },
			});
		}

		this.delete_solution = function() {
			var quiz_id = $('#next').attr("data_quiz_id");
			var index = parseInt($('#next').attr("data_index"), 10);
			var url_var = "{% url 'courses:delete_solution' quiz.course.id quiz.id %}";
			$.ajax({
				type: "get",
				url: url_var,
				data: {
					'quiz_id': quiz_id,
					'index': (index - 1)
				},
				success: function(data) {
					location.reload(); // refresh page
			    },
			    error: function() {
			        alert("Could not delete solution");
			    },
			});
		}

		$("#reveal").click(function(){
			reveal_answer();
		});

		$( document ).ready(function() {
			setup_grade_history();
			{% if answer %}
			reveal_answer();
			{% endif %}
			// $('.second_header').hide();
		});

		MathJax.Hub.Register.StartupHook("End Typeset", function (message) {
			$("#random_quizes").fadeIn("slow");
		})

		$("#delete_button").click(function(){
			$('#delete_button').hide();
			$('#really_delete_button').fadeIn();
			$('#really_delete_button').delay(3000).fadeOut(0, function() {
				$('#delete_button').show();
			});
			
		});

		this.setup_grade_history = function() {
			$( "#grade_history" ).hide();
			$( "#hide_grade" ).hide();
		}

		$( "#show_grade" ).click(function() {
			$( "#show_grade ").hide();
			$( "#hide_grade ").show();
			$( "#grade_history" ).show( "slow" );
		});

		$( "#hide_grade" ).click(function() {
			$( "#show_grade ").show();
			$( "#hide_grade ").hide();
			$( "#grade_history" ).hide( "slow" );
		});
	</script>

{% endblock %}